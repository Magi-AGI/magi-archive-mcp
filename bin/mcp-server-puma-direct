#!/usr/bin/env ruby
# frozen_string_literal: true

# Run Puma directly without rackup to avoid automatic middleware loading

require 'bundler/setup'
require 'puma'
require 'mcp'
require_relative '../lib/magi/archive/mcp'
require_relative '../lib/magi/archive/mcp/http_app'

# Load all tool classes
Dir[File.join(__dir__, '../lib/magi/archive/mcp/server/tools/**/*.rb')].sort.each { |f| require f }

# Get configuration from environment
PORT = ENV.fetch("MCP_SERVER_PORT", "3002").to_i
HOST = ENV.fetch("MCP_SERVER_HOST", "127.0.0.1")
working_directory = ENV["MAGI_WORKING_DIR"] || "/home/ubuntu"

# Initialize tools
magi_tools = Magi::Archive::Mcp::Tools.new

# Create server context
server_context = {
  magi_tools: magi_tools,
  working_directory: working_directory
}

# Create MCP server
mcp_server = ::MCP::Server.new(
  name: "magi-archive",
  version: Magi::Archive::Mcp::VERSION,
  tools: [
    Magi::Archive::Mcp::Server::Tools::GetCard,
    Magi::Archive::Mcp::Server::Tools::SearchCards,
    Magi::Archive::Mcp::Server::Tools::CreateCard,
    Magi::Archive::Mcp::Server::Tools::UpdateCard,
    Magi::Archive::Mcp::Server::Tools::DeleteCard,
    Magi::Archive::Mcp::Server::Tools::ListChildren,
    Magi::Archive::Mcp::Server::Tools::GetTags,
    Magi::Archive::Mcp::Server::Tools::SearchByTags,
    Magi::Archive::Mcp::Server::Tools::SuggestTags,
    Magi::Archive::Mcp::Server::Tools::GetRelationships,
    Magi::Archive::Mcp::Server::Tools::ValidateCard,
    Magi::Archive::Mcp::Server::Tools::GetRecommendations,
    Magi::Archive::Mcp::Server::Tools::GetTypes,
    Magi::Archive::Mcp::Server::Tools::RenderContent,
    Magi::Archive::Mcp::Server::Tools::AdminBackup,
    Magi::Archive::Mcp::Server::Tools::CreateWeeklySummary,
    Magi::Archive::Mcp::Server::Tools::HealthCheck,
    Magi::Archive::Mcp::Server::Tools::BatchCards,
    Magi::Archive::Mcp::Server::Tools::RunQuery,
    Magi::Archive::Mcp::Server::Tools::SpoilerScan
  ],
  server_context: server_context
)

# Set MCP server instance on the app class
Magi::Archive::Mcp::HttpApp.mcp_server_instance = mcp_server

# Debug: Print middleware stack
puts "=" * 80
puts "MIDDLEWARE STACK:"
Magi::Archive::Mcp::HttpApp.middleware.each_with_index do |middleware, i|
  puts "  #{i}. #{middleware.first} #{middleware[1..-1].inspect}"
end
puts "=" * 80

# Run Puma directly with our Rack app
Puma::Server.new(Magi::Archive::Mcp::HttpApp).tap do |server|
  server.add_tcp_listener HOST, PORT
  puts "Magi Archive MCP Server v#{Magi::Archive::Mcp::VERSION}"
  puts "Puma Direct Mode (No Rackup)"
  puts "Listening on http://#{HOST}:#{PORT}"
  puts "Working directory: #{working_directory}"
  puts "Authenticated as: #{magi_tools.client.config.username || 'API Key'}"
  server.run.join
end
