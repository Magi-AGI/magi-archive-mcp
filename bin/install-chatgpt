#!/usr/bin/env ruby
# frozen_string_literal: true

# Auto-installer for ChatGPT Desktop MCP server configuration
#
# Note: ChatGPT Desktop uses mcp.run platform for MCP integration
# rather than local configuration files like Claude Desktop.
# This installer provides setup instructions and alternative methods.

require "json"
require "fileutils"

class ChatGPTInstaller
  def initialize
    @server_path = File.expand_path("../mcp-server", __FILE__)
    @gem_root = File.expand_path("../..", @server_path)
  end

  def run
    puts "ðŸš€ Magi Archive MCP Server - ChatGPT Desktop Setup"
    puts ""

    # Check if server script exists
    unless File.exist?(@server_path)
      puts "âŒ Error: MCP server not found at #{@server_path}"
      puts "Please run 'bundle install' first"
      exit 1
    end

    # Make server executable
    FileUtils.chmod(0755, @server_path)

    puts "âš ï¸  Note: ChatGPT Desktop Integration"
    puts ""
    puts "ChatGPT Desktop uses the mcp.run platform for MCP server integration,"
    puts "which is different from Claude Desktop's local configuration approach."
    puts ""
    puts "Choose an integration method:"
    puts ""
    puts "1) Publish to mcp.run (requires account and server hosting)"
    puts "2) Use alternative OpenAI client with local MCP support"
    puts "3) Configure for Cursor IDE instead"
    puts "4) Exit and get more information"
    puts ""
    print "Select (1-4): "
    choice = gets.chomp

    case choice
    when "1"
      show_mcp_run_instructions
    when "2"
      show_alternative_client_instructions
    when "3"
      configure_cursor
    when "4"
      show_information
    else
      puts "Invalid choice"
      exit 1
    end
  end

  private

  def show_mcp_run_instructions
    puts ""
    puts "ðŸ“¦ Publishing to mcp.run"
    puts ""
    puts "To make Magi Archive available in ChatGPT Desktop via mcp.run:"
    puts ""
    puts "1. Create account at https://mcp.run"
    puts "2. Package this MCP server:"
    puts "   - Create npm package wrapper"
    puts "   - Include Ruby dependencies"
    puts "   - Set up server entry point"
    puts ""
    puts "3. Publish to npm registry"
    puts "4. Register on mcp.run platform"
    puts "5. Install via ChatGPT Desktop's MCP interface"
    puts ""
    puts "See: https://docs.mcp.run for detailed publishing guide"
    puts ""
    puts "Note: This requires hosting infrastructure for the server."
  end

  def show_alternative_client_instructions
    puts ""
    puts "ðŸ”„ Alternative OpenAI Clients with Local MCP Support"
    puts ""
    puts "Several third-party OpenAI-compatible clients support local MCP servers:"
    puts ""
    puts "Option A: Use OpenAI API with MCP Proxy"
    puts "  - Set up MCP proxy server"
    puts "  - Configure OpenAI API key"
    puts "  - Access via API calls"
    puts ""
    puts "Option B: Use Cursor IDE"
    puts "  - Supports local MCP servers"
    puts "  - Configuration file: ~/.cursor/mcp.json"
    puts "  - Integrates with OpenAI models"
    puts ""
    puts "Would you like to configure for Cursor now? (y/n): "
    response = gets.chomp.downcase

    configure_cursor if response == "y"
  end

  def configure_cursor
    puts ""
    puts "ðŸ“ Configuring for Cursor IDE"
    puts ""

    config_path = File.expand_path("~/.cursor/mcp.json")

    # Get authentication details
    puts "ðŸ” Authentication Setup"
    puts ""
    puts "Choose authentication method:"
    puts "  1) Username/Password (recommended)"
    puts "  2) API Key"
    print "\nSelect (1 or 2): "
    auth_choice = gets.chomp

    env_vars = if auth_choice == "1"
                 get_username_password
               else
                 get_api_key
               end

    # Add working directory option
    print "\nWorking directory for git repo scanning [#{Dir.pwd}]: "
    working_dir = gets.chomp
    working_dir = Dir.pwd if working_dir.empty?

    # Load or create config
    config = if File.exist?(config_path)
               JSON.parse(File.read(config_path))
             else
               FileUtils.mkdir_p(File.dirname(config_path))
               {}
             end

    # Add Magi Archive server config
    config["mcpServers"] ||= {}
    config["mcpServers"]["magi-archive"] = {
      "command" => "ruby",
      "args" => [@server_path, working_dir],
      "env" => env_vars.merge({
        "DECKO_API_BASE_URL" => "https://wiki.magi-agi.org/api/mcp",
        "BUNDLE_GEMFILE" => File.join(@gem_root, 'Gemfile')
      })
    }

    # Save config
    File.write(config_path, JSON.pretty_generate(config))
    puts ""
    puts "âœ… Cursor configuration saved to: #{config_path}"
    puts ""
    puts "Next steps:"
    puts "  1. Restart Cursor IDE"
    puts "  2. The Magi Archive tools will be available"
    puts "  3. Try asking about Magi Archive in Cursor"
  end

  def show_information
    puts ""
    puts "â„¹ï¸  More Information"
    puts ""
    puts "ChatGPT Desktop MCP Integration Status:"
    puts ""
    puts "ChatGPT Desktop currently uses mcp.run for MCP server discovery"
    puts "rather than local configuration files. This means:"
    puts ""
    puts "âœ“ Servers must be published to mcp.run platform"
    puts "âœ“ Or use alternative clients with local MCP support"
    puts ""
    puts "Supported Local MCP Clients:"
    puts "  - Claude Desktop (#{ENV['HOME']}/Library/Application Support/Claude/)"
    puts "  - Claude Code / Cline (VS Code extension)"
    puts "  - Cursor IDE (~/.cursor/mcp.json)"
    puts "  - Codex (if installed)"
    puts ""
    puts "For local development and testing, we recommend:"
    puts "  1. Use Claude Desktop (run: ruby bin/install-claude-desktop)"
    puts "  2. Use Claude Code (run: ruby bin/install-claude-code)"
    puts "  3. Use Cursor IDE (rerun this script and choose option 3)"
    puts ""
    puts "For ChatGPT Desktop integration, contact Magi Archive admin"
    puts "about publishing to mcp.run platform."
    puts ""
    puts "Resources:"
    puts "  - MCP Documentation: https://docs.mcp.run"
    puts "  - ChatGPT MCP Guide: https://docs.mcp.run/mcp-clients/chatgpt-desktop/"
    puts "  - Magi Archive Repo: https://github.com/your-org/magi-archive-mcp"
  end

  def get_username_password
    print "Decko username: "
    username = gets.chomp

    print "Decko password: "
    # Hide password input
    system "stty -echo" if STDIN.tty?
    password = gets.chomp
    system "stty echo" if STDIN.tty?
    puts ""

    {
      "MCP_USERNAME" => username,
      "MCP_PASSWORD" => password
    }
  end

  def get_api_key
    print "API Key: "
    api_key = gets.chomp

    print "Role (user/gm/admin): "
    role = gets.chomp

    {
      "MCP_API_KEY" => api_key,
      "MCP_ROLE" => role
    }
  end
end

# Run the installer
ChatGPTInstaller.new.run
