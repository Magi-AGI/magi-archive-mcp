#!/usr/bin/env ruby
# frozen_string_literal: true

# Auto-installer for Gemini CLI MCP server configuration
#
# This script configures Gemini CLI to use the Magi Archive MCP server
# Gemini CLI uses ~/.gemini/settings.json for MCP configuration

require "json"
require "fileutils"

class GeminiInstaller
  def initialize
    @server_path = File.expand_path("../mcp-server", __FILE__)
    @gem_root = File.expand_path("../..", @server_path)
  end

  def run
    puts "Magi Archive MCP Server - Gemini CLI Installer"
    puts ""

    # Check if server script exists
    unless File.exist?(@server_path)
      puts "Error: MCP server not found at #{@server_path}"
      puts "Please run 'bundle install' first"
      exit 1
    end

    # Make server executable
    FileUtils.chmod(0o755, @server_path)

    config_path = detect_config_path
    puts "Gemini config: #{config_path}"
    puts ""

    # Get authentication details
    puts "Authentication Setup"
    puts ""
    puts "Choose authentication method:"
    puts "  1) Username/Password (recommended)"
    puts "  2) API Key"
    print "\nSelect (1 or 2): "
    auth_choice = gets.chomp

    env_vars = if auth_choice == "1"
                 get_username_password
               else
                 get_api_key
               end

    # Add working directory option
    print "\nWorking directory for git repo scanning [#{Dir.pwd}]: "
    working_dir = gets.chomp
    working_dir = Dir.pwd if working_dir.empty?

    # Load or create config
    config = if File.exist?(config_path)
               JSON.parse(File.read(config_path))
             else
               FileUtils.mkdir_p(File.dirname(config_path))
               {}
             end

    # Add Magi Archive server config (Gemini CLI format)
    config["mcpServers"] ||= {}
    config["mcpServers"]["magi-archive"] = {
      "command" => "ruby",
      "args" => [@server_path, working_dir],
      "env" => env_vars.merge(
        {
          "DECKO_API_BASE_URL" => "https://wiki.magi-agi.org/api/mcp",
          "BUNDLE_GEMFILE" => File.join(@gem_root, "Gemfile")
        }
      )
    }

    # Save config
    File.write(config_path, JSON.pretty_generate(config))
    puts ""
    puts "Configuration saved to: #{config_path}"
    puts ""
    puts "Next steps:"
    puts "  1. Restart Gemini CLI (gemini command)"
    puts "  2. The Magi Archive tools will be available"
    puts "  3. Try: gemini 'Get the Main Page card from Magi Archive'"
    puts ""
    puts "Available tools:"
    puts "  - get_card: Fetch a card by name"
    puts "  - search_cards: Search for cards"
    puts "  - create_card: Create new cards"
    puts "  - update_card: Update existing cards"
    puts "  - list_children: Get child cards"
    puts "  - get_relationships: Explore card connections"
    puts ""
    puts "Note: If you haven't installed Gemini CLI yet, run:"
    puts "  npm install -g @anthropic/gemini-cli"
    puts "  (or see https://github.com/google-gemini/gemini-cli)"
  end

  private

  def detect_config_path
    case RbConfig::CONFIG["host_os"]
    when /darwin/i, /mac os/i
      # macOS
      File.expand_path("~/.gemini/settings.json")
    when /mswin|msys|mingw|cygwin|bccwin|wince|emc/i
      # Windows
      File.expand_path("~/.gemini/settings.json")
    else
      # Linux
      File.expand_path("~/.gemini/settings.json")
    end
  end

  def get_username_password
    print "Decko email address: "
    username = gets.chomp

    print "Decko password: "
    # Hide password input on Unix-like systems
    system "stty -echo" if STDIN.tty? && !Gem.win_platform?
    password = gets.chomp
    system "stty echo" if STDIN.tty? && !Gem.win_platform?
    puts ""

    {
      "MCP_USERNAME" => username,
      "MCP_PASSWORD" => password
    }
  end

  def get_api_key
    print "API Key: "
    api_key = gets.chomp

    print "Role (user/gm/admin): "
    role = gets.chomp

    {
      "MCP_API_KEY" => api_key,
      "MCP_ROLE" => role
    }
  end
end

# Run the installer
GeminiInstaller.new.run
