# PowerShell script for updating Magi Archive MCP server
# Works natively on Windows without requiring Git Bash

param(
    [Parameter(Position=0)]
    [ValidateSet('all', 'codex', 'claude')]
    [string]$Target = 'all'
)

$ErrorActionPreference = 'Stop'

# Colors for output
function Write-ColorOutput($ForegroundColor) {
    $fc = $host.UI.RawUI.ForegroundColor
    $host.UI.RawUI.ForegroundColor = $ForegroundColor
    if ($args) {
        Write-Output $args
    }
    $host.UI.RawUI.ForegroundColor = $fc
}

Write-ColorOutput Cyan "[*] Magi Archive MCP Server - Quick Update Utility"
Write-Output ""

# Get script directory and project root
$ScriptDir = Split-Path -Parent $MyInvocation.MyCommand.Path
$ProjectRoot = Split-Path -Parent $ScriptDir
$EnvFile = Join-Path $ProjectRoot ".env"

# Check if .env exists
if (Test-Path $EnvFile) {
    Write-ColorOutput Green "[+] Found existing .env file with credentials"

    # Load .env file
    Get-Content $EnvFile | ForEach-Object {
        $line = $_
        if ($line -match '^(\w+)=(.*)$') {
            $name = $matches[1].Trim()
            $value = $matches[2].Trim()
            [Environment]::SetEnvironmentVariable($name, $value, 'Process')
        }
    }
} else {
    Write-ColorOutput Yellow "[!] No .env file found. Setting up credentials..."
    Write-Output ""

    # Prompt for credentials
    $username = Read-Host "Decko username (email)"
    $password = Read-Host "Decko password" -AsSecureString
    $passwordPlain = [Runtime.InteropServices.Marshal]::PtrToStringAuto(
        [Runtime.InteropServices.Marshal]::SecureStringToBSTR($password))

    $workingDir = Read-Host "Working directory for git scanning [$ProjectRoot]"
    if ([string]::IsNullOrWhiteSpace($workingDir)) {
        $workingDir = $ProjectRoot
    }

    # Save to .env
    $envContent = @"
# Magi Archive MCP Server Configuration
# Auto-generated by bin/update-mcp.ps1

MCP_USERNAME=$username
MCP_PASSWORD=$passwordPlain
DECKO_API_BASE_URL=https://wiki.magi-agi.org/api/mcp
WORKING_DIR=$workingDir
"@
    $envContent | Set-Content $EnvFile

    # Set environment variables
    $env:MCP_USERNAME = $username
    $env:MCP_PASSWORD = $passwordPlain
    $env:DECKO_API_BASE_URL = "https://wiki.magi-agi.org/api/mcp"
    $env:WORKING_DIR = $workingDir

    Write-ColorOutput Green "[+] Saved credentials to .env"
    Write-Output ""
}

# Verify credentials
if ([string]::IsNullOrWhiteSpace($env:MCP_USERNAME) -or [string]::IsNullOrWhiteSpace($env:MCP_PASSWORD)) {
    Write-ColorOutput Red "[!] Error: Missing credentials in .env file"
    Write-Output "Please check $EnvFile and ensure MCP_USERNAME and MCP_PASSWORD are set"
    exit 1
}

# Set defaults
if ([string]::IsNullOrWhiteSpace($env:DECKO_API_BASE_URL)) {
    $env:DECKO_API_BASE_URL = "https://wiki.magi-agi.org/api/mcp"
}
if ([string]::IsNullOrWhiteSpace($env:WORKING_DIR)) {
    $env:WORKING_DIR = $ProjectRoot
}

# Detect which MCP clients are available
$CodexAvailable = $false
$ClaudeAvailable = $false

if (Get-Command codex -ErrorAction SilentlyContinue) {
    $CodexAvailable = $true
    Write-ColorOutput Green "[+] Codex CLI detected"
}

if (Get-Command claude -ErrorAction SilentlyContinue) {
    $ClaudeAvailable = $true
    Write-ColorOutput Green "[+] Claude CLI detected"
}

# Check for Claude Desktop config
$ClaudeDesktopConfig = Join-Path $env:APPDATA "Claude\claude_desktop_config.json"
if (Test-Path $ClaudeDesktopConfig) {
    $ClaudeAvailable = $true
    Write-ColorOutput Green "[+] Claude Desktop config detected"
}

if (-not $CodexAvailable -and -not $ClaudeAvailable) {
    Write-ColorOutput Red "[!] Error: No MCP clients detected (Codex or Claude)"
    Write-Output "Please install at least one MCP client first"
    exit 1
}

Write-Output ""

# Function to update Codex
function Update-Codex {
    if (-not $script:CodexAvailable) {
        Write-ColorOutput Yellow "[-] Skipping Codex (not installed)"
        return
    }

    Write-ColorOutput Cyan "--- Updating Codex CLI ---"

    # Check if already installed
    $existing = codex mcp list 2>&1 | Select-String "magi-archive"
    if ($existing) {
        Write-ColorOutput Yellow "[!] Removing existing magi-archive server..."
        codex mcp remove magi-archive 2>&1 | Out-Null
    }

    # Install with credentials
    Write-ColorOutput Green "[+] Installing magi-archive server..."

    $serverPath = Join-Path $ProjectRoot "bin\mcp-server"
    $gemfile = Join-Path $ProjectRoot "Gemfile"

    codex mcp add magi-archive `
        --env "MCP_USERNAME=$env:MCP_USERNAME" `
        --env "MCP_PASSWORD=$env:MCP_PASSWORD" `
        --env "DECKO_API_BASE_URL=$env:DECKO_API_BASE_URL" `
        --env "BUNDLE_GEMFILE=$gemfile" `
        -- bundle exec ruby $serverPath $env:WORKING_DIR

    Write-ColorOutput Green "[+] Codex CLI updated successfully"
    Write-Output ""
}

# Function to update Claude
function Update-Claude {
    if (-not $script:ClaudeAvailable) {
        Write-ColorOutput Yellow "[-] Skipping Claude (not installed)"
        return
    }

    Write-ColorOutput Cyan "--- Updating Claude CLI/Desktop ---"

    # Check if claude command exists
    if (Get-Command claude -ErrorAction SilentlyContinue) {
        # Use Claude CLI
        $existing = claude mcp list 2>&1 | Select-String "magi-archive"
        if ($existing) {
            Write-ColorOutput Yellow "[!] Removing existing magi-archive server..."
            claude mcp remove magi-archive 2>&1 | Out-Null
        }

        Write-ColorOutput Green "[+] Installing magi-archive server..."

        $serverPath = Join-Path $ProjectRoot "bin\mcp-server"
        $gemfile = Join-Path $ProjectRoot "Gemfile"

        claude mcp add magi-archive `
            --env "MCP_USERNAME=$env:MCP_USERNAME" `
            --env "MCP_PASSWORD=$env:MCP_PASSWORD" `
            --env "DECKO_API_BASE_URL=$env:DECKO_API_BASE_URL" `
            --env "BUNDLE_GEMFILE=$gemfile" `
            -- bundle exec ruby $serverPath $env:WORKING_DIR

        Write-ColorOutput Green "[+] Claude CLI updated successfully"
    } else {
        # Update Claude Desktop config manually
        Write-ColorOutput Yellow "[!] Claude CLI not found, updating config file manually..."

        if (-not (Test-Path $ClaudeDesktopConfig)) {
            Write-ColorOutput Red "[!] Claude Desktop config not found at: $ClaudeDesktopConfig"
            Write-Output "Please ensure Claude Desktop is installed"
            return
        }

        # Backup existing config
        Copy-Item $ClaudeDesktopConfig "$ClaudeDesktopConfig.backup"

        # Load and update JSON
        $config = Get-Content $ClaudeDesktopConfig -Raw | ConvertFrom-Json

        if (-not $config.mcpServers) {
            $config | Add-Member -NotePropertyName mcpServers -NotePropertyValue @{} -Force
        }

        $serverPath = Join-Path $ProjectRoot "bin\mcp-server"
        $gemfile = Join-Path $ProjectRoot "Gemfile"

        $config.mcpServers.'magi-archive' = @{
            command = 'bundle'
            args = @('exec', 'ruby', $serverPath, $env:WORKING_DIR)
            env = @{
                MCP_USERNAME = $env:MCP_USERNAME
                MCP_PASSWORD = $env:MCP_PASSWORD
                DECKO_API_BASE_URL = $env:DECKO_API_BASE_URL
                BUNDLE_GEMFILE = $gemfile
            }
        }

        $config | ConvertTo-Json -Depth 10 | Set-Content $ClaudeDesktopConfig

        Write-ColorOutput Green "[+] Claude Desktop config updated"
        Write-ColorOutput Yellow "[!] Please restart Claude Desktop to load the updated configuration"
    }

    Write-Output ""
}

# Perform updates based on target
switch ($Target) {
    'codex' { Update-Codex }
    'claude' { Update-Claude }
    'all' {
        Update-Codex
        Update-Claude
    }
}

# Final summary
Write-ColorOutput Green "========================================="
Write-ColorOutput Green "[SUCCESS] Update Complete!"
Write-Output ""
Write-Output "Credentials stored in: $EnvFile"
Write-Output "Working directory: $env:WORKING_DIR"
Write-Output ""
Write-Output "Quick update next time:"
Write-ColorOutput Blue "  .\bin\update-mcp.ps1          # Update all clients"
Write-ColorOutput Blue "  .\bin\update-mcp.ps1 codex    # Update only Codex"
Write-ColorOutput Blue "  .\bin\update-mcp.ps1 claude   # Update only Claude"
Write-Output ""
Write-Output "Available tools: get_card, search_cards, create_card, update_card,"
Write-Output "delete_card, health_check, spoiler_scan, batch_cards, and more!"
Write-Output ""
