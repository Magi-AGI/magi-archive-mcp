#!/usr/bin/env ruby
# frozen_string_literal: true

# Auto-installer for Claude Desktop MCP server configuration
#
# This script automatically configures Claude Desktop to use the
# Magi Archive MCP server by updating claude_desktop_config.json

require "json"
require "fileutils"

class ClaudeDesktopInstaller
  def initialize
    @config_path = detect_config_path
    @server_path = File.expand_path("../mcp-server", __FILE__)
    @gem_root = File.expand_path("../..", @server_path)
  end

  def run
    puts "ðŸš€ Magi Archive MCP Server - Claude Desktop Installer"
    puts ""

    # Check if server script exists
    unless File.exist?(@server_path)
      puts "âŒ Error: MCP server not found at #{@server_path}"
      exit 1
    end

    # Install Ruby dependencies
    install_dependencies

    # Make server executable
    FileUtils.chmod(0755, @server_path)

    puts "ðŸ“ Claude Desktop config: #{@config_path}"
    puts ""

    # Load or create config
    config = load_config

    # Get authentication details
    puts "ðŸ” Authentication Setup"
    puts ""
    puts "Choose authentication method:"
    puts "  1) Username/Password (recommended)"
    puts "  2) API Key"
    print "\nSelect (1 or 2): "
    auth_choice = gets.chomp

    env_vars = if auth_choice == "1"
                 get_username_password
               else
                 get_api_key
               end

    # Add working directory option
    print "\nWorking directory for git repo scanning [#{Dir.pwd}]: "
    working_dir = gets.chomp
    working_dir = Dir.pwd if working_dir.empty?

    # Add Magi Archive server config
    config["mcpServers"] ||= {}
    config["mcpServers"]["magi-archive"] = {
      "command" => "ruby",
      "args" => [@server_path, working_dir],
      "env" => env_vars.merge({
        "DECKO_API_BASE_URL" => "https://wiki.magi-agi.org/api/mcp",
        "BUNDLE_GEMFILE" => File.join(@gem_root, 'Gemfile')
      })
    }

    # Save config
    save_config(config)

    puts ""
    puts "âœ… Installation complete!"
    puts ""
    puts "Next steps:"
    puts "  1. Restart Claude Desktop"
    puts "  2. The Magi Archive tools will be available in Claude"
    puts "  3. Try asking: 'Get the Main Page card from Magi Archive'"
    puts ""
    puts "Available tools:"
    puts "  - get_card: Fetch a card by name"
    puts "  - search_cards: Search for cards"
    puts "  - create_card: Create new cards"
    puts "  - create_weekly_summary: Generate weekly summaries"
  end

  private

  def install_dependencies
    puts "ðŸ“¦ Installing Ruby dependencies..."
    puts ""

    # Check if bundle command exists
    bundle_exists = system("which bundle > /dev/null 2>&1") || system("where bundle > NUL 2>&1")

    unless bundle_exists
      puts "âš ï¸  Bundler not found. Installing bundler..."
      unless system("gem install bundler")
        puts "âŒ Error: Failed to install bundler"
        puts "Please install bundler manually: gem install bundler"
        exit 1
      end
    end

    # Run bundle install in gem root directory
    Dir.chdir(@gem_root) do
      puts "Running bundle install in #{@gem_root}..."
      puts ""

      unless system("bundle install")
        puts ""
        puts "âŒ Error: bundle install failed"
        puts "Please check that Ruby and Bundler are properly installed."
        exit 1
      end
    end

    puts ""
    puts "âœ… Dependencies installed successfully!"
    puts ""
  end

  def detect_config_path
    case RbConfig::CONFIG["host_os"]
    when /darwin/i, /mac os/i
      # macOS
      File.expand_path("~/Library/Application Support/Claude/claude_desktop_config.json")
    when /mswin|msys|mingw|cygwin|bccwin|wince|emc/i
      # Windows
      File.expand_path("~/AppData/Roaming/Claude/claude_desktop_config.json")
    else
      # Linux (assumed)
      File.expand_path("~/.config/Claude/claude_desktop_config.json")
    end
  end

  def load_config
    if File.exist?(@config_path)
      JSON.parse(File.read(@config_path))
    else
      # Create directory if it doesn't exist
      FileUtils.mkdir_p(File.dirname(@config_path))
      {}
    end
  rescue JSON::ParserError => e
    puts "âš ï¸  Warning: Existing config is invalid JSON, creating backup..."
    FileUtils.cp(@config_path, "#{@config_path}.backup")
    {}
  end

  def save_config(config)
    File.write(@config_path, JSON.pretty_generate(config))
    puts "ðŸ’¾ Configuration saved to: #{@config_path}"
  end

  def get_username_password
    print "Decko email address: "
    username = gets.chomp

    print "Decko password: "
    # Hide password input
    system "stty -echo" if STDIN.tty?
    password = gets.chomp
    system "stty echo" if STDIN.tty?
    puts ""

    {
      "MCP_USERNAME" => username,
      "MCP_PASSWORD" => password
    }
  end

  def get_api_key
    print "API Key: "
    api_key = gets.chomp

    print "Role (user/gm/admin): "
    role = gets.chomp

    {
      "MCP_API_KEY" => api_key,
      "MCP_ROLE" => role
    }
  end
end

# Run the installer
ClaudeDesktopInstaller.new.run
