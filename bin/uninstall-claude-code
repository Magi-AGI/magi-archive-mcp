#!/usr/bin/env ruby
# frozen_string_literal: true

# Uninstaller for Claude Code (VS Code Extension) MCP server configuration

require "json"
require "fileutils"

class ClaudeCodeUninstaller
  def initialize
    @config_path = detect_config_path
  end

  def run
    puts "üóëÔ∏è  Magi Archive MCP Server - Claude Code Uninstaller"
    puts ""

    unless File.exist?(@config_path)
      puts "‚úÖ No configuration found - nothing to uninstall"
      exit 0
    end

    puts "üìç Config file: #{@config_path}"
    puts ""

    # Load config
    begin
      config = JSON.parse(File.read(@config_path))
    rescue JSON::ParserError => e
      puts "‚ùå Error: Config file is invalid JSON"
      puts "You may need to manually delete: #{@config_path}"
      exit 1
    end

    # Check if magi-archive exists
    unless config.dig("mcpServers", "magi-archive")
      puts "‚úÖ Magi Archive server not found in config - nothing to uninstall"
      exit 0
    end

    # Show what will be removed
    puts "Found Magi Archive server configuration:"
    puts JSON.pretty_generate(config["mcpServers"]["magi-archive"])
    puts ""

    print "Remove this configuration? (y/N): "
    response = gets.chomp.downcase

    unless response == "y" || response == "yes"
      puts "‚ùå Cancelled - no changes made"
      exit 0
    end

    # Create backup
    backup_path = "#{@config_path}.backup.#{Time.now.to_i}"
    FileUtils.cp(@config_path, backup_path)
    puts "üíæ Backup created: #{backup_path}"

    # Remove the entry
    config["mcpServers"].delete("magi-archive")

    # Save updated config
    File.write(@config_path, JSON.pretty_generate(config))
    puts "‚úÖ Magi Archive server configuration removed"
    puts ""
    puts "Next steps:"
    puts "  1. Reload VS Code window (Cmd/Ctrl + Shift + P ‚Üí 'Reload Window')"
    puts "  2. Run bin/install-claude-code to reinstall if needed"
  end

  private

  def detect_config_path
    # Claude Code (VS Code extension) config location
    case RbConfig::CONFIG["host_os"]
    when /darwin/i, /mac os/i
      # macOS
      File.expand_path("~/Library/Application Support/Code/User/globalStorage/saoudrizwan.claude-dev/settings/cline_mcp_settings.json")
    when /mswin|msys|mingw|cygwin|bccwin|wince|emc/i
      # Windows
      File.expand_path("~/AppData/Roaming/Code/User/globalStorage/saoudrizwan.claude-dev/settings/cline_mcp_settings.json")
    else
      # Linux
      File.expand_path("~/.config/Code/User/globalStorage/saoudrizwan.claude-dev/settings/cline_mcp_settings.json")
    end
  end
end

# Run the uninstaller
ClaudeCodeUninstaller.new.run
