#!/usr/bin/env ruby
# frozen_string_literal: true

# Auto-installer for Codex CLI MCP server configuration
#
# This script automatically configures Codex CLI to use the
# Magi Archive MCP server using the 'codex mcp add' command

require "fileutils"

class CodexInstaller
  def initialize
    @server_path = File.expand_path("../mcp-server", __FILE__)
    @gem_root = File.expand_path("../..", @server_path)
  end

  def run
    puts "ðŸš€ Magi Archive MCP Server - Codex CLI Installer"
    puts ""

    # Check if server script exists
    unless File.exist?(@server_path)
      puts "âŒ Error: MCP server not found at #{@server_path}"
      exit 1
    end

    # Install Ruby dependencies
    install_dependencies

    # Make server executable
    FileUtils.chmod(0755, @server_path)

    # Check if codex command exists
    unless system("which codex > /dev/null 2>&1") || system("where codex > NUL 2>&1")
      puts "âŒ Error: 'codex' command not found"
      puts "Please install Codex CLI first"
      exit 1
    end

    puts ""

    # Get authentication details
    puts "ðŸ” Authentication Setup"
    puts ""
    puts "Choose authentication method:"
    puts "  1) Username/Password (recommended)"
    puts "  2) API Key"
    print "\nSelect (1 or 2): "
    auth_choice = gets.chomp

    env_vars = if auth_choice == "1"
                 get_username_password
               else
                 get_api_key
               end

    # Add working directory option
    print "\nWorking directory for git repo scanning [#{Dir.pwd}]: "
    working_dir = gets.chomp
    working_dir = Dir.pwd if working_dir.empty?

    # Build the codex mcp add command
    puts ""
    puts "ðŸ“¦ Registering MCP server with Codex CLI..."
    puts ""

    # Check if server already exists
    output = `codex mcp list 2>&1`
    if output.include?("magi-archive")
      puts "âš ï¸  Existing Magi Archive server found"
      puts ""
      print "Remove and reinstall? (Y/n): "
      response = gets.chomp.downcase
      unless response.empty? || response == "y" || response == "yes"
        puts "âŒ Installation cancelled"
        exit 0
      end

      print "Removing existing server... "
      if system("codex mcp remove magi-archive 2>&1")
        puts "âœ“"
      else
        puts "failed (may need manual removal)"
      end
      puts ""
    end

    # Build env flags
    env_flags = []
    env_vars.each do |key, value|
      env_flags << "--env"
      env_flags << "#{key}=#{value}"
    end

    # Add additional required env vars
    env_flags << "--env"
    env_flags << "DECKO_API_BASE_URL=https://wiki.magi-agi.org/api/mcp"
    env_flags << "--env"
    env_flags << "BUNDLE_GEMFILE=#{File.join(@gem_root, 'Gemfile')}"

    # Build full command
    cmd = [
      "codex", "mcp", "add",
      "magi-archive",
      *env_flags,
      "--",
      "bundle", "exec", "ruby",
      @server_path,
      working_dir
    ]

    puts "Running: #{cmd.join(' ')}"
    puts ""

    success = system(*cmd)

    if success
      puts ""
      puts "âœ… Installation complete!"
      puts ""
      puts "Verify installation:"
      puts "  codex mcp list"
      puts ""
      puts "Next steps:"
      puts "  1. The Magi Archive tools are now available in Codex"
      puts "  2. Start a new conversation or use an existing one"
      puts "  3. Try: codex 'Get the Main Page card from Magi Archive'"
      puts ""
      puts "Available tools:"
      puts "  - get_card, search_cards, create_card, update_card, delete_card"
      puts "  - list_children, get_tags, search_by_tags"
      puts "  - get_relationships, validate_card, get_recommendations"
      puts "  - get_types, render_content, admin_backup"
      puts "  - create_weekly_summary"
    else
      puts ""
      puts "âŒ Installation failed!"
      puts "Please check the error messages above and try again."
      exit 1
    end
  end

  private

  def install_dependencies
    puts "ðŸ“¦ Installing Ruby dependencies..."
    puts ""

    # Check if bundle command exists
    bundle_exists = system("which bundle > /dev/null 2>&1") || system("where bundle > NUL 2>&1")

    unless bundle_exists
      puts "âš ï¸  Bundler not found. Installing bundler..."
      unless system("gem install bundler")
        puts "âŒ Error: Failed to install bundler"
        puts "Please install bundler manually: gem install bundler"
        exit 1
      end
    end

    # Run bundle install in gem root directory
    Dir.chdir(@gem_root) do
      puts "Running bundle install in #{@gem_root}..."
      puts ""

      unless system("bundle install")
        puts ""
        puts "âŒ Error: bundle install failed"
        puts "Please check that Ruby and Bundler are properly installed."
        exit 1
      end
    end

    puts ""
    puts "âœ… Dependencies installed successfully!"
    puts ""
  end

  def get_username_password
    print "Decko email address: "
    username = gets.chomp

    print "Decko password: "
    # Hide password input
    system "stty -echo" if STDIN.tty?
    password = gets.chomp
    system "stty echo" if STDIN.tty?
    puts ""

    {
      "MCP_USERNAME" => username,
      "MCP_PASSWORD" => password
    }
  end

  def get_api_key
    print "API Key: "
    api_key = gets.chomp

    print "Role (user/gm/admin): "
    role = gets.chomp

    {
      "MCP_API_KEY" => api_key,
      "MCP_ROLE" => role
    }
  end
end

# Run the installer
CodexInstaller.new.run
