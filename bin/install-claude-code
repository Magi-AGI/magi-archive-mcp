#!/usr/bin/env ruby
# frozen_string_literal: true

# Auto-installer for Claude Code (VS Code Extension) MCP server configuration
#
# This script automatically configures Claude Code to use the
# Magi Archive MCP server by updating the MCP settings file

require "json"
require "fileutils"

class ClaudeCodeInstaller
  def initialize
    @config_path = detect_config_path
    @server_path = File.expand_path("../mcp-server", __FILE__)
  end

  def run
    puts "ðŸš€ Magi Archive MCP Server - Claude Code Installer"
    puts ""

    # Check if server script exists
    unless File.exist?(@server_path)
      puts "âŒ Error: MCP server not found at #{@server_path}"
      puts "Please run 'bundle install' first"
      exit 1
    end

    # Make server executable
    FileUtils.chmod(0755, @server_path)

    puts "ðŸ“ Claude Code config: #{@config_path}"
    puts ""

    # Load or create config
    config = load_config

    # Get authentication details
    puts "ðŸ” Authentication Setup"
    puts ""
    puts "Choose authentication method:"
    puts "  1) Username/Password (recommended)"
    puts "  2) API Key"
    print "\nSelect (1 or 2): "
    auth_choice = gets.chomp

    env_vars = if auth_choice == "1"
                 get_username_password
               else
                 get_api_key
               end

    # Add working directory option
    print "\nWorking directory for git repo scanning [#{Dir.pwd}]: "
    working_dir = gets.chomp
    working_dir = Dir.pwd if working_dir.empty?

    # Get the gem root directory (where Gemfile is located)
    gem_root = File.expand_path("../..", @server_path)

    # Add Magi Archive server config
    config["mcpServers"] ||= {}

    # Check if already installed
    if config["mcpServers"]["magi-archive"]
      puts "âš ï¸  Existing Magi Archive configuration found"
      print "Overwrite existing configuration? (Y/n): "
      response = gets.chomp.downcase
      unless response.empty? || response == "y" || response == "yes"
        puts "âŒ Installation cancelled"
        exit 0
      end
      puts "â™»ï¸  Overwriting existing configuration..."
      puts ""
    end

    config["mcpServers"]["magi-archive"] = {
      "command" => "bundle",
      "args" => ["exec", "ruby", @server_path, working_dir],
      "env" => env_vars.merge({
        "DECKO_API_BASE_URL" => "https://wiki.magi-agi.org/api/mcp",
        "BUNDLE_GEMFILE" => File.join(gem_root, "Gemfile")
      })
    }

    # Save config
    save_config(config)

    puts ""
    puts "âœ… Installation complete!"
    puts ""
    puts "Next steps:"
    puts "  1. Reload VS Code window (Cmd/Ctrl + Shift + P â†’ 'Reload Window')"
    puts "  2. The Magi Archive tools will be available in Claude Code"
    puts "  3. Try asking: 'Get the Main Page card from Magi Archive'"
    puts ""
    puts "Available tools:"
    puts "  - get_card, search_cards, create_card, update_card, delete_card"
    puts "  - list_children, get_tags, search_by_tags"
    puts "  - get_relationships, validate_card, get_recommendations"
    puts "  - get_types, render_content, admin_backup"
    puts "  - create_weekly_summary"
  end

  private

  def detect_config_path
    # Claude Code (VS Code extension) config location
    case RbConfig::CONFIG["host_os"]
    when /darwin/i, /mac os/i
      # macOS
      File.expand_path("~/Library/Application Support/Code/User/globalStorage/saoudrizwan.claude-dev/settings/cline_mcp_settings.json")
    when /mswin|msys|mingw|cygwin|bccwin|wince|emc/i
      # Windows
      File.expand_path("~/AppData/Roaming/Code/User/globalStorage/saoudrizwan.claude-dev/settings/cline_mcp_settings.json")
    else
      # Linux
      File.expand_path("~/.config/Code/User/globalStorage/saoudrizwan.claude-dev/settings/cline_mcp_settings.json")
    end
  end

  def load_config
    if File.exist?(@config_path)
      JSON.parse(File.read(@config_path))
    else
      # Create directory if it doesn't exist
      FileUtils.mkdir_p(File.dirname(@config_path))
      {}
    end
  rescue JSON::ParserError => e
    puts "âš ï¸  Warning: Existing config is invalid JSON, creating backup..."
    FileUtils.cp(@config_path, "#{@config_path}.backup")
    {}
  end

  def save_config(config)
    File.write(@config_path, JSON.pretty_generate(config))
    puts "ðŸ’¾ Configuration saved to: #{@config_path}"
  end

  def get_username_password
    print "Decko username: "
    username = gets.chomp

    print "Decko password: "
    # Hide password input
    system "stty -echo" if STDIN.tty?
    password = gets.chomp
    system "stty echo" if STDIN.tty?
    puts ""

    {
      "MCP_USERNAME" => username,
      "MCP_PASSWORD" => password
    }
  end

  def get_api_key
    print "API Key: "
    api_key = gets.chomp

    print "Role (user/gm/admin): "
    role = gets.chomp

    {
      "MCP_API_KEY" => api_key,
      "MCP_ROLE" => role
    }
  end
end

# Run the installer
ClaudeCodeInstaller.new.run
