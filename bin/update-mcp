#!/usr/bin/env bash
# frozen_string_literal: true

# Quick MCP Server Update Utility
# Updates Magi Archive MCP server for Codex and/or Claude Desktop
# without requiring credential re-entry each time

set -e  # Exit on error

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
ENV_FILE="$PROJECT_ROOT/.env"

echo -e "${BLUE}ğŸ”„ Magi Archive MCP Server - Quick Update Utility${NC}"
echo ""

# Check if .env exists and load it
if [ -f "$ENV_FILE" ]; then
    echo -e "${GREEN}âœ“${NC} Found existing .env file with credentials"
    source "$ENV_FILE"
else
    echo -e "${YELLOW}âš ${NC}  No .env file found. Let's set up your credentials."
    echo ""

    # Prompt for credentials
    read -p "Decko username (email): " MCP_USERNAME
    read -sp "Decko password: " MCP_PASSWORD
    echo ""
    read -p "Working directory for git scanning [${PROJECT_ROOT}]: " WORKING_DIR
    WORKING_DIR=${WORKING_DIR:-$PROJECT_ROOT}

    # Save to .env
    cat > "$ENV_FILE" << EOF
# Magi Archive MCP Server Configuration
# Auto-generated by bin/update-mcp

MCP_USERNAME=$MCP_USERNAME
MCP_PASSWORD=$MCP_PASSWORD
DECKO_API_BASE_URL=https://wiki.magi-agi.org/api/mcp
WORKING_DIR=$WORKING_DIR
EOF

    echo -e "${GREEN}âœ“${NC} Saved credentials to .env"
    echo ""
fi

# Verify we have required credentials
if [ -z "$MCP_USERNAME" ] || [ -z "$MCP_PASSWORD" ]; then
    echo -e "${RED}âœ—${NC} Error: Missing credentials in .env file"
    echo "Please check $ENV_FILE and ensure MCP_USERNAME and MCP_PASSWORD are set"
    exit 1
fi

# Set defaults
DECKO_API_BASE_URL=${DECKO_API_BASE_URL:-https://wiki.magi-agi.org/api/mcp}
WORKING_DIR=${WORKING_DIR:-$PROJECT_ROOT}

# Detect which MCP clients are available
CODEX_AVAILABLE=false
CLAUDE_AVAILABLE=false

if command -v codex &> /dev/null; then
    CODEX_AVAILABLE=true
    echo -e "${GREEN}âœ“${NC} Codex CLI detected"
fi

if command -v claude &> /dev/null; then
    CLAUDE_AVAILABLE=true
    echo -e "${GREEN}âœ“${NC} Claude CLI detected"
fi

# Check if Claude Desktop config exists (Windows)
CLAUDE_DESKTOP_CONFIG="$APPDATA/Claude/claude_desktop_config.json"
if [ -f "$CLAUDE_DESKTOP_CONFIG" ]; then
    CLAUDE_AVAILABLE=true
    echo -e "${GREEN}âœ“${NC} Claude Desktop config detected"
fi

if [ "$CODEX_AVAILABLE" = false ] && [ "$CLAUDE_AVAILABLE" = false ]; then
    echo -e "${RED}âœ—${NC} Error: No MCP clients detected (Codex or Claude)"
    echo "Please install at least one MCP client first"
    exit 1
fi

echo ""

# Parse arguments
UPDATE_TARGET="all"
if [ $# -gt 0 ]; then
    case "$1" in
        --codex|codex)
            UPDATE_TARGET="codex"
            ;;
        --claude|claude)
            UPDATE_TARGET="claude"
            ;;
        --all|all)
            UPDATE_TARGET="all"
            ;;
        --help|help|-h)
            echo "Usage: $0 [target]"
            echo ""
            echo "Targets:"
            echo "  all     Update all detected MCP clients (default)"
            echo "  codex   Update only Codex CLI"
            echo "  claude  Update only Claude CLI/Desktop"
            echo ""
            echo "Options:"
            echo "  -h, --help    Show this help message"
            echo ""
            echo "Credentials are stored in .env file (created on first run)"
            exit 0
            ;;
        *)
            echo -e "${RED}âœ—${NC} Unknown target: $1"
            echo "Use --help for usage information"
            exit 1
            ;;
    esac
fi

# Function to update Codex
update_codex() {
    if [ "$CODEX_AVAILABLE" = false ]; then
        echo -e "${YELLOW}âŠ˜${NC}  Skipping Codex (not installed)"
        return
    fi

    echo -e "${BLUE}â”â”â” Updating Codex CLI â”â”â”${NC}"

    # Check if already installed
    if codex mcp list 2>&1 | grep -q "magi-archive"; then
        echo -e "${YELLOW}âš ${NC}  Removing existing magi-archive server..."
        codex mcp remove magi-archive || true
    fi

    # Install with credentials
    echo -e "${GREEN}âœ“${NC} Installing magi-archive server..."
    codex mcp add magi-archive \
        --env "MCP_USERNAME=$MCP_USERNAME" \
        --env "MCP_PASSWORD=$MCP_PASSWORD" \
        --env "DECKO_API_BASE_URL=$DECKO_API_BASE_URL" \
        --env "BUNDLE_GEMFILE=$PROJECT_ROOT/Gemfile" \
        -- bundle exec ruby "$PROJECT_ROOT/bin/mcp-server" "$WORKING_DIR"

    echo -e "${GREEN}âœ“${NC} Codex CLI updated successfully"
    echo ""
}

# Function to update Claude
update_claude() {
    if [ "$CLAUDE_AVAILABLE" = false ]; then
        echo -e "${YELLOW}âŠ˜${NC}  Skipping Claude (not installed)"
        return
    fi

    echo -e "${BLUE}â”â”â” Updating Claude CLI/Desktop â”â”â”${NC}"

    # Check if claude command exists
    if command -v claude &> /dev/null; then
        # Use Claude CLI
        if claude mcp list 2>&1 | grep -q "magi-archive"; then
            echo -e "${YELLOW}âš ${NC}  Removing existing magi-archive server..."
            claude mcp remove magi-archive || true
        fi

        echo -e "${GREEN}âœ“${NC} Installing magi-archive server..."
        claude mcp add magi-archive \
            --env "MCP_USERNAME=$MCP_USERNAME" \
            --env "MCP_PASSWORD=$MCP_PASSWORD" \
            --env "DECKO_API_BASE_URL=$DECKO_API_BASE_URL" \
            --env "BUNDLE_GEMFILE=$PROJECT_ROOT/Gemfile" \
            -- bundle exec ruby "$PROJECT_ROOT/bin/mcp-server" "$WORKING_DIR"

        echo -e "${GREEN}âœ“${NC} Claude CLI updated successfully"
    else
        # Update Claude Desktop config manually
        echo -e "${YELLOW}âš ${NC}  Claude CLI not found, updating config file manually..."

        if [ ! -f "$CLAUDE_DESKTOP_CONFIG" ]; then
            echo -e "${RED}âœ—${NC} Claude Desktop config not found at: $CLAUDE_DESKTOP_CONFIG"
            echo "Please ensure Claude Desktop is installed"
            return 1
        fi

        # Backup existing config
        cp "$CLAUDE_DESKTOP_CONFIG" "$CLAUDE_DESKTOP_CONFIG.backup"

        # Use Python or Node to update JSON (if available)
        if command -v python &> /dev/null; then
            python -c "
import json
import sys

config_path = '$CLAUDE_DESKTOP_CONFIG'
with open(config_path, 'r') as f:
    config = json.load(f)

if 'mcpServers' not in config:
    config['mcpServers'] = {}

config['mcpServers']['magi-archive'] = {
    'command': 'bundle',
    'args': ['exec', 'ruby', '$PROJECT_ROOT/bin/mcp-server', '$WORKING_DIR'],
    'env': {
        'MCP_USERNAME': '$MCP_USERNAME',
        'MCP_PASSWORD': '$MCP_PASSWORD',
        'DECKO_API_BASE_URL': '$DECKO_API_BASE_URL',
        'BUNDLE_GEMFILE': '$PROJECT_ROOT/Gemfile'
    }
}

with open(config_path, 'w') as f:
    json.dump(config, f, indent=2)

print('Updated Claude Desktop config')
"
            echo -e "${GREEN}âœ“${NC} Claude Desktop config updated"
            echo -e "${YELLOW}âš ${NC}  Please restart Claude Desktop to load the updated configuration"
        else
            echo -e "${RED}âœ—${NC} Python not found - cannot update JSON config automatically"
            echo "Please manually add magi-archive to $CLAUDE_DESKTOP_CONFIG"
            return 1
        fi
    fi

    echo ""
}

# Perform updates based on target
case "$UPDATE_TARGET" in
    codex)
        update_codex
        ;;
    claude)
        update_claude
        ;;
    all)
        update_codex
        update_claude
        ;;
esac

# Final summary
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}âœ… Update Complete!${NC}"
echo ""
echo "Credentials stored in: $ENV_FILE"
echo "Working directory: $WORKING_DIR"
echo ""
echo "Quick update next time:"
echo "  ${BLUE}./bin/update-mcp${NC}          # Update all clients"
echo "  ${BLUE}./bin/update-mcp codex${NC}    # Update only Codex"
echo "  ${BLUE}./bin/update-mcp claude${NC}   # Update only Claude"
echo ""
echo "Available tools: get_card, search_cards, create_card, update_card,"
echo "delete_card, health_check, spoiler_scan, batch_cards, and more!"
echo ""
