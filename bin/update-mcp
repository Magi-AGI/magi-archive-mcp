#!/usr/bin/env ruby
# frozen_string_literal: true

# Quick update utility for Magi Archive MCP server
# Updates both Codex and Claude CLI configurations using existing credentials

require "fileutils"

class McpUpdater
  def initialize
    @script_dir = File.dirname(__FILE__)
    @project_root = File.expand_path("..", @script_dir)
    @env_file = File.join(@project_root, ".env")
  end

  def run
    puts "üîÑ Magi Archive MCP Server - Quick Update Utility"
    puts ""

    load_credentials
    detect_clients

    unless @codex_available || @claude_available
      puts "‚ùå Error: No MCP clients detected (Codex or Claude)"
      puts "Please install at least one MCP client first"
      exit 1
    end

    update_clients

    puts ""
    puts "=" * 50
    puts "‚úÖ Update Complete!"
    puts ""
    puts "Credentials stored in: #{@env_file}"
    puts "Working directory: #{@working_dir}"
    puts ""
    puts "Quick update next time:"
    puts "  ruby bin/update-mcp       # Update all clients"
    puts "  ./bin/update-mcp          # Alternative (Unix)"
    puts ""
    puts "Available tools: get_card, search_cards, create_card, update_card,"
    puts "delete_card, health_check, spoiler_scan, batch_cards, and more!"
    puts ""
  end

  private

  def load_credentials
    unless File.exist?(@env_file)
      puts "‚ö†Ô∏è  No .env file found. Setting up credentials..."
      puts ""
      create_env_file
    end

    puts "‚úÖ Found existing .env file with credentials"

    # Load .env file
    File.readlines(@env_file).each do |line|
      line = line.strip
      next if line.empty? || line.start_with?("#")

      if line =~ /^(\w+)=(.*)$/
        ENV[$1] = $2
      end
    end

    # Verify required credentials
    unless ENV["MCP_USERNAME"] && ENV["MCP_PASSWORD"]
      puts "‚ùå Error: Missing credentials in .env file"
      puts "Please ensure MCP_USERNAME and MCP_PASSWORD are set"
      exit 1
    end

    # Set defaults
    ENV["DECKO_API_BASE_URL"] ||= "https://wiki.magi-agi.org/api/mcp"
    @working_dir = ENV["WORKING_DIR"] || @project_root
  end

  def create_env_file
    print "Decko email address: "
    username = gets.chomp

    print "Decko password: "
    # Hide password input
    system "stty -echo" if STDIN.tty?
    password = gets.chomp
    system "stty echo" if STDIN.tty?
    puts ""

    print "Working directory for git scanning [#{@project_root}]: "
    working_dir = gets.chomp
    working_dir = @project_root if working_dir.empty?

    # Save to .env
    File.write(@env_file, <<~ENV)
      # Magi Archive MCP Server Configuration
      # Auto-generated by bin/update-mcp

      MCP_USERNAME=#{username}
      MCP_PASSWORD=#{password}
      DECKO_API_BASE_URL=https://wiki.magi-agi.org/api/mcp
      WORKING_DIR=#{working_dir}
    ENV

    puts "‚úÖ Saved credentials to .env"
    puts ""

    # Set environment variables
    ENV["MCP_USERNAME"] = username
    ENV["MCP_PASSWORD"] = password
    ENV["DECKO_API_BASE_URL"] = "https://wiki.magi-agi.org/api/mcp"
    ENV["WORKING_DIR"] = working_dir
  end

  def detect_clients
    @codex_available = system("which codex > #{dev_null} 2>&1") || system("where codex > #{dev_null} 2>&1")
    @claude_available = system("which claude > #{dev_null} 2>&1") || system("where claude > #{dev_null} 2>&1")

    puts "‚úÖ Codex CLI detected" if @codex_available
    puts "‚úÖ Claude CLI detected" if @claude_available
    puts ""
  end

  def update_clients
    update_codex if @codex_available
    update_claude if @claude_available
  end

  def update_codex
    puts "--- Updating Codex CLI ---"

    # Check if already installed
    output = `codex mcp list 2>&1`
    if output.include?("magi-archive")
      puts "‚ö†Ô∏è  Removing existing magi-archive server..."
      system("codex mcp remove magi-archive > #{dev_null} 2>&1")
    end

    puts "üì¶ Installing magi-archive server..."

    server_path = File.join(@project_root, "bin", "mcp-server")
    gemfile = File.join(@project_root, "Gemfile")

    cmd = [
      "codex", "mcp", "add", "magi-archive",
      "--env", "MCP_USERNAME=#{ENV['MCP_USERNAME']}",
      "--env", "MCP_PASSWORD=#{ENV['MCP_PASSWORD']}",
      "--env", "DECKO_API_BASE_URL=#{ENV['DECKO_API_BASE_URL']}",
      "--env", "BUNDLE_GEMFILE=#{gemfile}",
      "--",
      "bundle", "exec", "ruby", server_path, @working_dir
    ]

    if system(*cmd)
      puts "‚úÖ Codex CLI updated successfully"
    else
      puts "‚ùå Codex CLI update failed"
    end

    puts ""
  end

  def update_claude
    puts "--- Updating Claude CLI ---"

    # Remove from all scopes
    output = `claude mcp list 2>&1`
    if output.include?("magi-archive")
      puts "‚ö†Ô∏è  Removing existing magi-archive server from all scopes..."
      %w[user local project].each do |scope|
        system("claude mcp remove --scope #{scope} magi-archive > #{dev_null} 2>&1")
      end
    end

    puts "üì¶ Installing magi-archive server..."

    server_path = File.join(@project_root, "bin", "mcp-server")
    gemfile = File.join(@project_root, "Gemfile")

    cmd = [
      "claude", "mcp", "add",
      "--scope", "user",
      "--transport", "stdio",
      "magi-archive",
      "--env", "MCP_USERNAME=#{ENV['MCP_USERNAME']}",
      "--env", "MCP_PASSWORD=#{ENV['MCP_PASSWORD']}",
      "--env", "DECKO_API_BASE_URL=#{ENV['DECKO_API_BASE_URL']}",
      "--env", "BUNDLE_GEMFILE=#{gemfile}",
      "--",
      "bundle", "exec", "ruby", server_path, @working_dir
    ]

    if system(*cmd)
      puts "‚úÖ Claude CLI updated successfully"
    else
      puts "‚ùå Claude CLI update failed"
    end

    puts ""
  end

  def dev_null
    RUBY_PLATFORM =~ /mswin|mingw|windows/ ? "NUL" : "/dev/null"
  end
end

# Run the updater
McpUpdater.new.run
